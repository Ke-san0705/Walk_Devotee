<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shot</title>
  <link rel="stylesheet" href="style.css">
  <script src="main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/lite.umd.js"></script>
</head>
<body class="bg-home">
  <div class="page">
    <header class="header">
      <button class="secondary-btn" id="backButton" type="button" style="max-width:120px; padding:10px 12px;">＜ 戻る</button>
      <div class="header-title">SHOT</div>
      <div class="badge" id="targetName">TARGET</div>
    </header>

    <div class="shot-wrapper">
      <div class="video-frame">
        <video id="camera" autoplay playsinline muted></video>
        <canvas id="snapshot"></canvas>
      </div>
      <div class="shutter-row">
        <button class="shutter-btn" id="shutterButton" aria-label="シャッター"></button>
      </div>
      <div class="text-muted">ターゲットと位置を合わせてください。許容誤差は 7m です。</div>
      <div id="errorBox" class="error-box" style="display:none;">
        <div id="errorText">位置情報を取得できませんでした。</div>
        <div class="button-row" style="margin-top:10px;">
          <button class="secondary-btn" id="retryButton">再試行</button>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay-loading" id="loadingOverlay">
    <div>ヨミコミチュウ…</div>
    <div class="loader-dots"><span></span><span></span><span></span></div>
  </div>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('snapshot');
    const shutterButton = document.getElementById('shutterButton');
    const overlay = document.getElementById('loadingOverlay');
    const errorBox = document.getElementById('errorBox');
    const errorText = document.getElementById('errorText');
    const retryButton = document.getElementById('retryButton');
    const targetName = document.getElementById('targetName');
    const backButton = document.getElementById('backButton');
    const detailId = App.readDetailId();
    const target = App.getDetailTarget(detailId);
    let stream;

    if (targetName) {
      targetName.textContent = target.title || `DETAIL ${detailId}`;
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
      } catch (err) {
        showError('カメラへのアクセスに失敗しました。権限を確認してください。');
      }
    }

    async function captureFrame() {
      overlay.classList.add('active');
      errorBox.style.display = 'none';
      canvas.width = video.videoWidth || 1080;
      canvas.height = video.videoHeight || 1920;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
      let coords = await readExif(blob);
      if (!coords) {
        coords = await getGeo();
      }

      if (!coords) {
        overlay.classList.remove('active');
        showError('位置情報を取得できませんでした。もう一度お試しください。');
        return;
      }

      const distance = App.haversineDistance(coords.lat, coords.lon, target.lat, target.lon);
      localStorage.setItem('lastDetailId', detailId);
      localStorage.setItem('lastDistance', Math.round(distance));
      const destination = distance <= 7 ? 'success.html' : 'failure.html';
      setTimeout(() => {
        window.location.href = `${destination}?detailId=${detailId}&dist=${Math.round(distance)}`;
      }, 200);
    }

    async function readExif(blob) {
      if (window.exifr && exifr.parse) {
        try {
          const data = await exifr.parse(blob, ['latitude', 'longitude']);
          if (data && data.latitude && data.longitude) {
            return { lat: data.latitude, lon: data.longitude };
          }
        } catch (e) {
          console.warn('EXIF 読み込み失敗', e);
        }
      }
      return null;
    }

    function getGeo() {
      if (!navigator.geolocation) return Promise.resolve(null);
      return new Promise(resolve => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => {
            console.warn('Geolocation error', err);
            resolve(null);
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 10000 }
        );
      });
    }

    function showError(msg) {
      errorText.textContent = msg;
      errorBox.style.display = 'block';
    }

    shutterButton.addEventListener('click', captureFrame);
    retryButton.addEventListener('click', () => {
      overlay.classList.remove('active');
      startCamera();
    });

    backButton.addEventListener('click', () => {
      if (window.history.length > 1) {
        window.history.back();
      } else if (detailId) {
        window.location.href = `detail${detailId}.html?detailId=${detailId}`;
      } else {
        window.location.href = 'mission.html';
      }
    });

    window.addEventListener('beforeunload', () => {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
      }
    });

    startCamera();
  </script>
</body>
</html>
